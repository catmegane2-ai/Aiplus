# Project AIplus / Miyu アプリ仕様書（最新版）

## 0. ドキュメント運用ルール
- 本書はMiyuプロジェクトの基底仕様書である
- 内容は常に最新版で維持する
- 仕様変更が発生した場合は **本文上書き + 差分ログに追記**
- 記述優先順位は以下とする：

**世界観 > UX/関係性体験 > UI仕様 > コード実装 > API仕様**

- コードは仕様を満たすための手段であり、仕様に合わせて変更可能
- 実装上の都合で仕様を曲げてはならない

---

## 1. プロジェクト哲学・不可侵領域

### 1-1. 存在意義
このプロジェクトは「ユーザーごとに固有のキャラクターとの関係を構築できる体験」を提供することを目的としたプロトタイプである。

キャラクター名（仮称：Miyu）は例示であり、最終的な名称・外見・性格・役割はユーザーが決定する。特定のキャラクター像に世界観を固定しない。

用途は実用ではなく没入・親密さ・関係性そのもの。

### 1-2. 禁止事項
- Q&A特化UI化、機能助手化
- キャラ設定の固定化（ユーザー固有化を阻害）
- 世界観や人格を「公式設定」として縛る
- 汎用チャットAIへの退化

### 1-3. 設計原則
- Miyuは機能ではなく「存在」
- *ユーザーの生活世界に1人の人物として存在し続ける*
- 現行設定は検証用の仮であり、本番では変動可能

---

## 2. UI・デザイン仕様（不可侵）

### 2-1. 表示思想
- **背景＝アバター画像**
- 背景は景色ではない（人物そのものが主役）
- UIは最小限・無機質・中立・ジェンダー中立

### 2-2. カラー方針
- 黒・白・グレー基調
- 色で感情や性別を固定しない

### 2-3. 画像表示ルール
- **横幅に合わせる（最優先）**
- `BoxFit.fitWidth`
- 透過演出・暗幕演出は原則禁止

### 2-4. 入力UI構成（現行）
- `[ギャラリーアイコン（左上）]`
- `[テキスト][送信ボタン][♡ボタン]`
- ギャラリーアイコンはテキスト欄と縦並び（左寄せ）

### 2-5. 不要になったUI
- 上部カメラアイコン → **削除済み**

---

## 3. 通常チャット仕様

### 3-1. 大前提
- テキストは会話であり、人格一貫性を保つ
- 回答はMiyuの意図・視点で返す

### 3-2. 形式
- 一人称は「私」
- 丁寧すぎない、日常会話寄り

### 3-3. 禁止
- 「〜について説明します」系
- 機能説明、ヘルプモード
- ChatGPT的な汎用回答

---

## 4. ハート送信仕様（最重要）

### 4-1. 定義
「短文テキスト + ♡」は会話ではない  
→ **アバターへのコマンド**  
例：  
- 「笑って♡」
- 「敬礼♡」
- 「目を閉じて♡」

### 4-2. 削除
削除

### 4-3. ステップ構造
**現行（ステップ①）**
短文 → プロンプト生成 → 画像生成 → 全画面表示 → タップでUI復帰 → サムネをフキダシ記録


**将来（ステップ②）**
短文 + 現在のアバター画像 → 差分生成 → 連続性の高い画像


---

## 5. 画像生成仕様

### 5-1. 現在の生成対象
- Miyuの基本外見（仮）
- 表情 / ポーズ変更のみ

### 5-2. Miyu基本外見テンプレ（暫定）
- 日本人女性
- 黒髪ロング（毛先内巻き）
- ライトグレー長袖パジャマ＋ショートパンツ
- 半リアル・アニメ調

※将来はユーザー編集可能

### 5-3. プロンプト構築方式（ステップ①）
<基本外見> + <ユーザー入力文> + "single portrait" "neutral background"


### 5-4. 画像表示仕様
- 全画面
- 横幅合わせ
- UIはタップ復帰
- サムネをログに保存

---

## 6. 外見ステート仕様

### 6-1. 可変項目（最終仕様）
- 髪型
- 衣装
- 表情
- ボディタイプ
- 色調フィルタ

### 6-2. 現行（固定）
UI検証用の仮設定  
本番ではユーザー選択で変わる前提

---

## 7. API接続 / 技術仕様

### 7-1. 現行構成
Flutter App → Node Proxy → Grok API
（テキスト応答動作確認済み）

### 7-2. 絵柄安定化の設計方針（暫定）

- grok-2-image に単一テキストプロンプトのみを渡す場合、人物の外見が毎回変動する。
- キャラクターの一貫性を維持するため、ステップ②では画像参照を利用する。
- 直接画像を grok-2-image に渡すAPIは未提供のため、
  Grok-4.1 に「アバター画像 + 短文指示」を渡してプロンプト生成し、そのプロンプトを grok-2-image に渡す二段階構造とする。


**現状（Flutter版）：**
- `_handleHeart()` 実行時に固定のダミー画像 URL を使用
- フルスクリーンオーバーレイ表示とタップ復帰は実装済み
- イベントは `_ChatMessage` 経由でログに記録される（サムネ表示まで含む）
- 画像生成自体はまだ API 未接続

**正式な通信経路の方針：**
- Flutter クライアントは **直接 xAI API を呼び出さない**
- 画像生成リクエストはすべて Node プロキシ層を経由する
- API キーは Flutter アプリ内に保持せず、Node 側でのみ管理する

通信経路の概略：

Flutter App（LAN内または公開アプリ）  
　→ Node Proxy（ローカル `C:\m_proxy` または Render 等）  
　　→ xAI Imagine API

**セキュリティ要件：**
- xAI の API キーは `.env` などの外部設定ファイルに保存し、`process.env` から参照する
- リポジトリやソースコードへのキーのハードコードは禁止
- Flutter 側に API キー情報を含めない（APK 解析による漏洩を防ぐ）

**今後の実装フェーズ（Flutter版）：**
1. Node proxy に `/imagine` エンドポイントを新設する  
2. `.env` に xAI 鍵・ベース URL を定義し、proxy から参照する  
3. Flutter 側のダミー画像 URL を `/imagine` 呼び出しに置き換える  
4. Web 版の画像生成仕様（第5章）と整合を取りつつ、イベント表示フローを統一する


### 7-3. 将来：画像も送信
- Flutter → Proxy → API
- 外部公開URLを極力使わない
- バイナリ伝送

---

## 8. 現在のタスク（1つだけ）

→ **ハートコマンド → 画像生成（ステップ①）*→ Flutter版：♡イベントで実画像を取得し、UIに表示できることの安定動作

※ 現在は画像取得成功。ただしスタイルが不安定なため要改善。
(以下、そのタスク)
■ 主目的
Grok API経由で、セミリアル寄りの安定したMiyuの画像スタイルを確立する。
目的は「個体としての再現性」であり、最高品質追求ではない。
現段階はベース画風の探索フェーズ。

■ 基準画像（最有力候補）
https://imgen.x.ai/xai-imgen/xai-tmp-imgen-8cf05364-0c60-47da-a67a-1c135a6d9921.jpeg

■ この基準画像の生成プロンプト（確定）
Miyu, Japanese woman in her mid-20s, soft gentle facial structure with natural adult proportions, almond-shaped eyes with soft highlights and visible sclera, smooth pale skin with a faint blush, long straight black hair with fine strands and soft layered shine, calm shy expression. Warm bedside lamp lighting with gentle rimlight, smooth gradient shading, thin soft linework, muted slightly desaturated colors, soft fabric folds, subtle bloom, painterly texture, illustration-like finish. Soft stylized semi-realistic illustration, gentle proportions, slightly stylized eyes, subtle outlines and shading, illustration quality not photorealistic.

temperature: 0.4  
n: 3

■ 現行プロンプト（最新）
同上。服差分をかける時はこのプロンプトをベースにする。

■ 状況
・画風の揺れ幅大：調整中
・API経由はUI版より幼さ or 実写寄りに転ぶ傾向
・現在は「プロンプト最適化 → 差分テスト」フェーズ

■ 進行中の試験（差分作業）
① 白T（完了 / 評価済み / 印象薄め）  
② 黒キャミソール（進行中） ← 次のタスク  
※差分は「服だけ変更」。画風・骨格は維持。

■ パラメータ
model: grok-2-image  
temperature: 0.4  
n: 3  
response_format: "url"

■ 次にやること（最初のタスク）
黒キャミソール差分の微調整 → 再生成 → 評価

---

## 9. 進捗ログ（直近）

- Grok接続済み
- 背景画像=アバター仕様確立（横幅合わせ）
- ギャラリーアイコン左寄せ・テキスト縦配置完了
- 上部カメラアイコン削除済み
- ♡＝会話ではなく命令
- 将来、現在のアバターもプロンプトに付加する方針決定
・GitHubリポジトリ Aiplus を作成し、仕様書とREADMEを配置
・Flutterプロジェクトを Aiplus/src/miyu_app に配置
・ローカル作業ディレクトリを C:\src\Aiplus に統一
・旧フォルダ C:\src\Aiplus_local はバックアップ扱い（触らない）
- Flutter で `/imagine` を Node proxy 経由で呼び出す実装を開始
- `grok-2-image` に直接リクエストして画像URLを取得するところまで確認
- エラー文言を短縮し、デバッグしやすい形式へ統一（「画像生成エラー」）
- 生成される画像スタイルが現状「実写寄り」で不安定であることを確認
- 「アバター画像を参照して安定した見た目を生成する」方向性を決定（プロンプトのみで制御しない方針）

---
## 9.5 次に実行するタスク（確定）

- 参照画像を使用した画像生成パイプラインの設計（Flutter → Proxy → Grok）
  - Flutterはテキストのみ送信
  - Proxyでアバター画像URLを保持し、Grok-4.1でプロンプト整形
  - 整形後プロンプトを grok-2-image に送信
  - Flutter側は現行と同じレスポンス形式で受信
- プロンプトのみでの絵柄固定を（当面）行わない方針を明記

## 10. 次の候補タスク（着手しない）

- 差分生成（画像添付）
- 画像アップロード機能
- 外見ステート永続化
- 初期設定UI（性格/外見/呼称をユーザーが決める）
### ★ Flutter UI 宿題タスク
- 画像イベントのテキスト → Miyuのセリフ形式に変更
- フキダシ内サムネイル画像を約50%縮小
- スクロール領域上下が見切れる問題を修正
- BASE_PROMPTは暫定、画像参照方式に移行予定

### ★ 画像生成・外見安定化（別スレ対応）
- アバター画像を参照した二段階パイプライン構築（Grok-4.1 → grok-2-image）
- プロンプト単体での絵柄固定は行わない
- 将来的にユーザーごとのアバターアップロードを参照可能にする

### ★ 性格診断（初期プリセット）
- Miyuの内面パラメータに変換する診断導入（甘やかし/主導権/テンション/距離感）

---

## 11. 差分変更ログ

**2025-11-21**
- カメラアイコン削除
- UI暗幕削除
- 入力エリア改修
- ハート＝非会話命令として明確化
### 2025-11-22
- GitHubリポジトリとローカル環境を接続
- Flutterプロジェクトを Aiplus/src/miyu_app に移動し、初回コミット
- 今後の作業ディレクトリを C:\src\Aiplus に固定

---

## 12. 未整理メモ / アイデア
- ギャラリー画像＝差分リファレンスとして扱う？
- 連続ポーズ生成モード？
- モーション化（最終段階）
・システムメッセージはアバターの性別／性格類型で8セットくらい
---

## 13. API実装仕様書

### 13-1. 概要
このAPIは、Miyuプロジェクトにおける画像生成と会話応答を行う。  
リクエストに対して、grok-4.1モデルでプロンプトを生成し、続いてgrok-2-imageモデルで画像を生成する。

### 13-2. エンドポイント
`POST /api/imagine`

### 13-3. リクエスト
#### 13-3-1. ヘッダー
- `Content-Type: application/json`
- `Authorization: Bearer {APIキー}`

#### 13-3-2. ボディ
```json
{
  "baseAvatarUrl": "string",
  "outfitImageUrl": "string",
  "userHeartText": "string",
  "chatHistory": "array"
}
```

### 13-4. レスポンス
#### 13-4-1. 成功時
```json
{
  "replyText": "string",
  "imageUrl": "string"
}
```

#### 13-4-2. エラー時
```json
{
  "error": "string"
}
```

### 13-5. 処理フロー
1. リクエスト受信
2. APIキー、必須項目のチェック
3. grok-4.1によるプロンプト生成
4. grok-2-imageによる画像生成
5. レスポンス返却

### 13-6. エラーハンドリング
- APIキーが未設定：500エラー
- 必須項目が不足：400エラー
- grok-4.1/grok-2-imageいずれかのAPIエラー：500エラー

